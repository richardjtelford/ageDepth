---
title: "SS0206-15GC"
author: "Richard J. Telford"
date: "October 2, 2016"
output: html_document
---

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("r/ImportOxcal.R")
library("dplyr")
library("ggplot2")
```

```{r data}
dates <- read.table(header = TRUE, text = 
"depth_corr	Lab_Code	raw_14C_age	error
3.5	Poz-55129	820	50
10.5	Poz-47991	1695	30
23	Poz-60305	2365	35
36	Poz-55130	3050	90
45.5	ETH56961	3742	55
51	Poz-55131	4310	60
57	Poz-60276	4360	35
69.5	ETH56189	5268	102
71.5	Poz-51071	5420	50
74.5	ETH56190	5417	114
82.5	Poz-57691	6550	50
89.5	ETH56191	6495	147
93	Poz-60277	6450	50
95.5	ETH56962	6490	56
99	Poz-55133	6960	60
100.5	ETH56963	7165	107
102.5	Poz-57692	7650	40
108.5	Poz-55134	7830	50
118.5	Poz-55119	8240	60
129	Poz-60278	8690	50
135.4	ETH56964	9139	94
140.5	Poz-55120	9620	50
150.5	Poz-55121	10160	70
154.5	ETH56192	10292	241
161	Poz-59472	10630	60
170.5	Poz-57336	11380	60
180.5	Poz-59473	11900	110
206	Poz-55135	12690	100
216	Poz-59475	13130	130
226	Poz-55137	14190	100
240.5	ETH56965	13930	109
251.5	Poz-47990	14380	100
270.5	ETH56966	15093	152
271	Poz-55138	14280	100
290.5	Poz-57339	14950	70
300.5	Poz-59476	15480	90
312.5	Poz-51070	16010	100
352	Poz-56508	16670	70
406.5	Poz-47988	17730	130
440.5	Poz-55140	18690	120
490.5	Poz-55141	20150	220
535.5	Poz-51066	20930	170
")

##sort so oldest first
dates <- dates[order(dates$depth_corr, decreasing = TRUE), ]
```


Make P sequence model

```{r make_Psequence}
ageDepths <- paste0(' R_date("Dep', dates$depth_corr, '",', dates$raw_14C_age, ',', dates$error, '){\n   z=', dates$depth_corr, ';\n   Outlier(0.05);\n };')
ageDepths <- paste(ageDepths, collapse = "\n")
commandp <- paste(curve, DR,
  'P_Sequence("k",1,1,U(-2,2)){',
  ' Outlier_Model("General",T(5),U(0,4),"t");',
  ' Boundary("Bottom");',
   ageDepths,
  ' Boundary("Top");',
  '};', sep = "\n")
writeLines(commandp)
```

Run P sequence
```{r run_Psequence}
writeLines(commandp, con = "oxcalp.input")
system(paste("~/oxcal/OxCal/bin/OxCalLinux", "oxcalp.input"))
```

Read P sequence model

```{r importOxcal}
js <- readLines("oxcalp.js")

posterior <- get.OxCal(js, posterior = TRUE)
likelihood <- get.OxCal(js, posterior = FALSE)

allprob <- rbind(posterior, likelihood)

mod <- allprob %>% 
  filter(posterior == TRUE) %>% 
  group_by(depth, comment) %>% 
  mutate(sumProb = cumsum(prob)) %>% 
  mutate(sumProb = sumProb/max(sumProb)) %>% 
  summarise(
    medianDate = approx(x = sumProb, y = date, xout =  0.5)$y,
    lowCI = approx(x = sumProb, y = date, xout = 0.025)$y,
    highCI = approx(x = sumProb, y = date, xout = 0.975)$y
  ) 


allprob %>% filter(grepl("Dep", comment)) %>% 
  ggplot(aes(x = depth, y = date, size = prob, colour = posterior, group = comment)) +   
     geom_ribbon(data = mod, aes(x = depth, ymax = highCI, ymin = lowCI), inherit.aes = FALSE, alpha  = 0.2) +
     geom_line(data = mod, aes(x = depth, y = medianDate), inherit.aes = FALSE, colour = "grey40") +
     geom_line(alpha = 0.6) + 
     scale_x_reverse() +
     scale_size(range = c(0, 6)) +
     coord_flip() +
     labs(x = "Depth cm", y = "Date yr BP") + 
     theme_bw() + 
     ggtitle("SS0206-15GC")


allprob %>% filter(posterior == TRUE) %>% 
  ggplot(aes(x = depth, y = date, alpha = prob)) + 
           geom_line() + 
           scale_x_reverse() +
           scale_alpha(range = c(0, 1)) +
           coord_flip() +
           labs(x = "Depth cm", y = "Date yr BP")+
  geom_line(data = mod, aes(x = depth, y = medianDate), colour = "red", inherit.aes = FALSE)
```

